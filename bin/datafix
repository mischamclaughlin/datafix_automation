#!/usr/bin/env ruby

require 'yaml'
require 'optparse'

$LOAD_PATH.unshift(File.expand_path('../lib', __dir__))
require 'datafix'

options = {
  config: nil,
  input: nil,
  mapping: nil,
  run_accounts: true,
  run_subscriptions: true
}

parser = OptionParser.new do |opts|
  opts.banner = 'Usage: bin/datafix [options] [INPUT.xlsx MAPPING.yml]'

  opts.on('-c', '--config PATH', 'Path to config YAML') do |path|
    options[:config] = path
  end

  opts.on('-i', '--input PATH', 'Path to input XLSX file') do |path|
    options[:input] = path
  end

  opts.on('-m', '--mapping PATH', 'Path to mapping YAML file') do |path|
    options[:mapping] = path
  end

  opts.on('--only TARGETS', 'Run subset: accounts, subs, or both') do |targets|
    case targets.downcase
    when 'accounts'
      options[:run_accounts] = true
      options[:run_subscriptions] = false
    when 'subs', 'subscriptions'
      options[:run_accounts] = false
      options[:run_subscriptions] = true
    when 'both'
      options[:run_accounts] = true
      options[:run_subscriptions] = true
    else
      abort "Unknown value for --only: #{targets} (expected accounts, subs, or both)"
    end
  end

  opts.on('-h', '--help', 'Show this help message') do
    puts opts
    exit
  end
end

parser.parse!

config_path =
  if options[:config]
    File.expand_path(options[:config], Dir.pwd)
  else
    candidates = [
      File.expand_path('../config/datafix.yml', __dir__),
      File.expand_path('../datafix.yml', __dir__)
    ]
    candidates.find { |path| File.exist?(path) }
  end

config = config_path && File.exist?(config_path) ? (YAML.load_file(config_path) || {}) : {}

input_path = options[:input] || ARGV[0] || config['input_file']
php_admin_path = options[:mapping] || ARGV[1] || config['php_admin_file']

unless input_path && php_admin_path
  abort "#{parser}\n\n" \
        "Either provide INPUT.xlsx and MAPPING.yml as arguments,\n" \
        "use --input/--mapping options, or set 'input_file' and 'php_admin_file' in a config YAML."
end

input = DataFix::ParseFiles.new(input_file: input_path).parse_files(input_path)
php_admin_data = DataFix::ParseFiles.new(input_file: php_admin_path).parse_files(php_admin_path)

builder = DataFix::BuildData.new(parsed_data: input, parsed_php_admin_data: php_admin_data)

builder.build_account_data if options[:run_accounts]
builder.build_subscription_data if options[:run_subscriptions]
